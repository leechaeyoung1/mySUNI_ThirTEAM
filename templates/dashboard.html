<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Dashboard</title>
  <!-- Plotly CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>KPI Metrics</h2>
  <ul>
    <li>ë¶ˆëŸ‰ë¥ : {{ kpis.defect_rate }}</li>
    <li>ìƒì‚°ëŸ‰: {{ kpis.production_qty }}</li>
    <li>ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰: {{ kpis.energy_usage }}</li>
  </ul>

  <!-- ğŸ“Š Plotly ê·¸ë˜í”„ -->
  <div>
    <h3>Production Trend</h3>
    <div id="prod-chart"></div>
  </div>

  <div style="display: flex; gap: 30px;">
    <div style="width: 50%;">
      <h3>Defect Rate Distribution</h3>
      <div id="defect-chart"></div>
    </div>
    <div style="width: 50%;">
      <h3>Energy Usage by Line</h3>
      <div id="energy-chart"></div>
    </div>
  </div>

  <!-- ğŸ“‹ CSV í…Œì´ë¸” -->
  <h2>CSV í…Œì´ë¸”</h2>
  <table border="1">
    <thead>
      <tr>
        {% for col in columns %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in tables %}
        <tr>
          {% for cell in row %}
            <td>{{ cell }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ğŸ“„ PDF ì €ì¥ ë²„íŠ¼ -->
  <button onclick="downloadPDF()">ğŸ“„ PDF ì €ì¥</button>

  <script>
    // PDF ì €ì¥ ìš”ì²­
    function downloadPDF() {
      const rows = [...document.querySelectorAll("tbody tr")].map(row =>
        [...row.cells].map(cell => cell.innerText)
      );
      const columns = [...document.querySelectorAll("thead th")].map(th => th.innerText);
      const data = rows.map(row => Object.fromEntries(row.map((val, i) => [columns[i], val])));

      fetch("/download_pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data })
      })
      .then(res => res.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "report.pdf";
        a.click();
      });
    }

    // ğŸ“ˆ Plotly ê·¸ë˜í”„ ë Œë”ë§
    const prodChart = {{ prod_chart | safe }};
    const defectChart = {{ defect_chart | safe }};
    const energyChart = {{ energy_chart | safe }};

    Plotly.newPlot("prod-chart", prodChart.data, prodChart.layout);
    Plotly.newPlot("defect-chart", defectChart.data, defectChart.layout);
    Plotly.newPlot("energy-chart", energyChart.data, energyChart.layout);
  </script>
</body>
</html>
